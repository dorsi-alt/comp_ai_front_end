<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Create Bot — Companion AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .page-hero { padding: 8rem 0 3rem; text-align: center; }
    .page-title { font-size: clamp(32px, 4vw, 56px); line-height: 1.1; }
    .form-grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .stack { display: grid; gap: 12px; }
    .input, .select, .textarea {
      width: 100%; padding: 12px 14px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.04); color: inherit;
      outline: none;
    }
    .textarea { min-height: 92px; resize: vertical; }
    .input:focus, .select:focus, .textarea:focus { border-color: rgba(255,255,255,.18); }
    .select-field { display: grid; gap: 8px; }
    .select-shell {
      position: relative;
      border-radius: 12px;
      padding: 1px;
      background: linear-gradient(135deg, rgba(191,255,0,.22), rgba(34,211,238,.18));
    }
    .select-shell::after {
      content: "";
      position: absolute;
      right: 14px;
      top: 50%;
      width: 10px;
      height: 10px;
      border-left: 2px solid rgba(15,15,15,.8);
      border-bottom: 2px solid rgba(15,15,15,.8);
      transform-origin: center;
      transform: translateY(-50%) rotate(-45deg);
      pointer-events: none;
    }
    .select-shell .fancy-select {
      appearance: none;
      -webkit-appearance: none;
      border-radius: 11px;
      border: none;
      background: rgba(7,7,7,.85);
      color: inherit;
      width: 100%;
      padding: 12px 42px 12px 16px;
      font: inherit;
      letter-spacing: .02em;
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
      transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease;
    }
    .select-shell .fancy-select:focus {
      border-color: rgba(191,255,0,.55);
      box-shadow: 0 0 0 3px rgba(191,255,0,.18);
      outline: none;
      transform: translateY(-1px);
    }
    .select-shell .fancy-select option {
      background: #050505;
      color: #f4f4f4;
    }
    .status-steps { display: grid; gap: 10px; margin: 0; padding: 0; }
    .status-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .status-item .status-text { font-size: 0.9rem; font-family: inherit; letter-spacing: 0.03em; }
    .status-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: rgba(255,255,255,.28);
      box-shadow: 0 0 0 3px rgba(255,255,255,.08);
      transition: background .2s ease, box-shadow .2s ease;
    }
    .status-item.ok { border-color: rgba(34,211,238,.35); box-shadow: 0 0 0 1px rgba(34,211,238,.2); }
    .status-item.ok .status-dot { background: #22d3ee; box-shadow: 0 0 0 3px rgba(34,211,238,.22); }
    .status-item.warn { border-color: rgba(255,209,102,.35); box-shadow: 0 0 0 1px rgba(255,209,102,.18); }
    .status-item.warn .status-dot { background: #ffd166; box-shadow: 0 0 0 3px rgba(255,209,102,.22); }
    .status-item.err { border-color: rgba(255,123,123,.35); box-shadow: 0 0 0 1px rgba(255,123,123,.18); }
    .status-item.err .status-dot { background: #ff7b7b; box-shadow: 0 0 0 3px rgba(255,123,123,.22); }
    .status-item .status-note { color: rgba(255,255,255,.6); font-size: 0.75rem; margin-left: auto; }
    .contact-badge.btn-primary {
      position: relative;
      min-width: 160px;
      justify-content: center;
      gap: 10px;
    }
    .contact-badge.btn-primary .btn-spinner {
      display: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,.3);
      border-top-color: rgba(255,255,255,.9);
      animation: spin .8s linear infinite;
    }
    .contact-badge.btn-primary.is-busy { opacity: .8; transform: translateY(0) !important; cursor: progress; }
    .contact-badge.btn-primary.is-busy .btn-spinner { display: inline-flex; }
    .contact-badge.btn-primary.is-busy .btn-label { opacity: .7; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    pre.code {
      background: rgba(0,0,0,.35); border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px; padding: 14px; max-height: 440px; overflow: auto;
    }
  </style>
</head>

<body class="loaded internal-page">
  <!-- Header -->
  <header class="site-header">
    <div class="header-container">
      <div class="logo-container">
        <img src="LOGO.png" alt="Logo" class="logo-image">
      </div>
      <nav class="main-nav">
        <ul>
          <li><a href="dashboard.html" class="glass-card">Dashboard</a><div class="nav-hover-square"></div></li>
        </ul>
      </nav>
      <div class="contact-link">
        <a href="index.html" class="contact-badge">HOME</a>
      </div>
    </div>
  </header>

  <div class="gradient-reveal"></div>

  <!-- Hero -->
  <section class="section">
    <div class="section-content page-hero">
      <h1 class="page-title">Create a <span class="accent-strong">Bot</span></h1>
      <p class="subtitle">Configure credentials, personality and schedules.</p>
    </div>
  </section>

  <!-- Form -->
  <section class="section">
    <div class="section-content">
      <div class="stack">
        <!-- Identity -->
        <div class="glass-card">
          <h3>Bot Identity</h3>
          <div class="form-grid">
            <div>
              <label>Username</label>
              <input id="username" class="input" placeholder="wallet-as-username" />
            </div>
            <div>
              <label>Bot Name</label>
              <input id="botName" class="input" placeholder="my_marketing_bot" />
            </div>
            <div class="select-field">
              <label>Post Schedule</label>
              <div class="select-shell">
                <select id="postSchedule" class="fancy-select">
                  <option value="hourly">hourly</option>
                  <option value="daily">daily</option>
                  <option value="weekly">weekly</option>
                </select>
              </div>
            </div>
            <div class="select-field">
              <label>Reply Schedule</label>
              <div class="select-shell">
                <select id="replySchedule" class="fancy-select">
                  <option value="hourly">hourly</option>
                  <option value="daily">daily</option>
                  <option value="disabled">disabled</option>
                </select>
              </div>
            </div>
          </div>
          <div class="btn-row" style="margin-top:8px">
            <button id="btnSaveDefaults" class="contact-badge">Save Defaults</button>
          </div>
        </div>

        <!-- Status Dashboard -->
        <div class="glass-card">
          <h3>Setup Progress</h3>
          <ul class="status-steps">
            <li id="statusForm" class="status-item warn">
              <span class="status-dot" aria-hidden="true"></span>
              <span class="status-text">1️⃣ Form: Details incomplete</span>
              <span class="status-note">Fill persona + schedules</span>
            </li>
            <li id="statusTwitter" class="status-item">
              <span class="status-dot" aria-hidden="true"></span>
              <span class="status-text">2️⃣ Twitter: Not connected</span>
              <span class="status-note">Connect account</span>
            </li>
            <li id="statusBot" class="status-item">
              <span class="status-dot" aria-hidden="true"></span>
              <span class="status-text">3️⃣ Bot: Not created</span>
              <span class="status-note">Create to finish</span>
            </li>
          </ul>
        </div>


        <!-- Personality -->
        <div class="glass-card">
          <h3>Persona — Personality</h3>
          <div class="form-grid">
            <div><label>Name</label><input id="p_name" class="input" placeholder="Marketing Pro" /></div>
            <div><label>Role</label><input id="p_role" class="input" placeholder="Digital Marketing Expert" /></div>
            <div><label>Tone</label><input id="p_tone" class="input" placeholder="Professional yet friendly" /></div>
            <div><label>Voice</label><input id="p_voice" class="input" placeholder="Authoritative but approachable" /></div>
          </div>
        </div>

        <div class="glass-card">
          <h3>Persona — Communication Style</h3>
          <div class="form-grid">
            <div><label>Writing Style</label><input id="cs_style" class="input" placeholder="Clear and concise" /></div>
            <div><label>Humor Level</label><input id="cs_humor" class="input" placeholder="Light" /></div>
            <div><label>Emoji Usage</label><input id="cs_emoji" class="input" placeholder="Moderate" /></div>
            <div><label>Hashtag Strategy</label><input id="cs_hash" class="input" placeholder="2-3 relevant hashtags" /></div>
          </div>
        </div>

        <div class="glass-card">
          <h3>Persona — Interests & Expertise</h3>
          <div class="form-grid">
            <div><label>Primary Focus</label><input id="ie_primary" class="input" placeholder="Digital Marketing" /></div>
            <div><label>Secondary Interests</label><input id="ie_secondary" class="input" placeholder="Tech trends, entrepreneurship" /></div>
            <div><label>Buzzwords to Use</label><input id="ie_buzz_use" class="input" placeholder="growth, optimize, scale" /></div>
            <div><label>Buzzwords to Avoid</label><input id="ie_buzz_avoid" class="input" placeholder="synergy, paradigm" /></div>
          </div>
        </div>

        <div class="glass-card">
          <h3>Persona — Content Approach</h3>
          <div class="form-grid">
            <div><label>Marketing Style</label><input id="ca_style" class="input" placeholder="Value-first" /></div>
            <div><label>Call to Action</label><input id="ca_cta" class="input" placeholder="Subtle" /></div>
            <div><label>Target Audience</label><input id="ca_audience" class="input" placeholder="Business owners" /></div>
            <div><label>Value Proposition</label><input id="ca_value" class="input" placeholder="Actionable insights" /></div>
          </div>
        </div>

        <div class="glass-card">
          <h3>Persona — Brand Voice Examples</h3>
          <div class="form-grid">
            <div><label>Excitement</label><input id="bv_ex" class="input" placeholder="🚀 Ready to grow?" /></div>
            <div><label>Curiosity</label><input id="bv_cu" class="input" placeholder="What if there was a better way?" /></div>
            <div><label>Authority</label><input id="bv_au" class="input" placeholder="Here's what works:" /></div>
            <div><label>Encouragement</label><input id="bv_en" class="input" placeholder="You've got this!" /></div>
          </div>
        </div>

        <div class="glass-card">
          <h3>Persona — Posting Guidelines</h3>
          <div class="form-grid">
            <div><label>Tweet Length</label><input id="pg_length" class="input" placeholder="150-280 chars" /></div>
            <div><label>Content Mix</label><input id="pg_mix" class="input" placeholder="70% value, 30% engagement" /></div>
            <div><label>Response Style</label><input id="pg_response" class="input" placeholder="Quick and helpful" /></div>
            <div><label>Brand Consistency</label><input id="pg_brand" class="input" placeholder="Always professional" /></div>
          </div>
        </div>

        <!-- <div class="glass-card">
          <h3>Custom Instructions</h3>
          <label>One instruction per line</label>
          <textarea id="custom_instructions" class="textarea" placeholder="Always provide actionable advice
Keep tone positive and motivating
Include relevant hashtags"></textarea>
        </div> -->

        <!-- Twitter Connection & Bot Creation -->
        <div class="glass-card">
          <h3>Connect & Create</h3>
          <p style="margin-bottom: 16px; opacity: 0.8;">First connect your Twitter account, then create your bot.</p>

          <div class="btn-row" style="margin-bottom: 16px;">
            <button id="btnConnectTwitter" type="button" class="glass-card">1. Connect Twitter</button>
            <span id="oauthStatus" class="mono" style="font-size:0.9rem"></span>
          </div>

          <div class="btn-row" style="margin-bottom: 16px;">
            <button id="btnLoadExample" class="glass-card">Load Example Data</button>
            <button id="btnCreate" class="contact-badge btn-primary" type="button" data-label-default="2. Create Bot" data-label-busy="Creating…" data-label-redirect="Opening dashboard…">
              <span class="btn-label">2. Create Bot</span>
              <span class="btn-spinner" aria-hidden="true"></span>
            </button>
         </div>

          <div id="createStatus" class="mono" style="font-size: 0.9rem; min-height: 20px;"></div>
        </div>

        <!-- <div class="glass-card">
          <h3>Request Preview</h3>
          <pre id="preview" class="code mono">{}</pre>
        </div>

        <div class="glass-card">
          <h3>Server Response</h3>
          <pre id="response" class="code mono">{}</pre>
        </div> -->
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-content-section">
      <div class="footer-content">
        <div class="footer-left">
          <p>xxx xxxxxxxx</p><p>xx xxxxx</p><p>xxxxx xx xxxx</p><p>xxxxxxxxx</p><p>xxxxxxx xxxxx</p><p>xxx xxxxxxx</p>
        </div>
        <div class="footer-right">
          <p>xxxxxxxxxx xxxxx xxxxxxx</p><p>xxxxxxxx xxxxxxxx</p><p>xxxxxxxxxxxxx xxxxxxx</p><p>xxxx xxxxxxxxx xxxxxx</p><p>xx xxxxx xxx xxxxxxxxxxxx</p><p>xxxxx xxxxxxx xxxxxxx xxx</p>
        </div>
      </div>
      <div class="footer-credits">
        <p>xxxxx xxxxxx & xxxxx xx <a href="https://open.spotify.com/artist/6YXgRMajnjib8j6Cxzcryp?si=iiLnt59BRp6QgKGizkG5Zg" target="_blank">@xxxxxxxx</a></p>
      </div>
    </div>
    <div class="footer-svg-section">
      <img class="footer-svg" src="C.png" alt="">
    </div>
  </footer>

  <!-- Scripts -->
  <script src="config.js"></script>
  <script src="twitter-oauth.js"></script>
  <script>
  const $ = (id) => document.getElementById(id);
  const P = (o) => JSON.stringify(o, null, 2);

  // ---------- State (reads from URL ?username=&base= or localStorage) ----------
  const params = new URLSearchParams(location.search);
  const saved = JSON.parse(localStorage.getItem("tbp.defaults") || "{}");

  const API_BASE_URL = window.API_CONFIG.BASE_URL;

  const state = {
    username: params.get("username") || saved.username || "",
    botName: params.get("bot_name") || saved.botName || "",
  };

  // Safely grab optional elements (some are commented out in your HTML)
  const preview = $("preview");
  const responseEl = $("response");
  const oauthStatus = $("oauthStatus");
  const createStatus = $("createStatus");
  const statusForm = $("statusForm");
  const statusTwitter = $("statusTwitter");
  const statusBot = $("statusBot");
  const createBtn = $("btnCreate");
  const createBtnLabel = createBtn?.querySelector('.btn-label') || null;
  const defaultCreateLabel = createBtn?.dataset.labelDefault || createBtnLabel?.textContent || 'Create Bot';
  const busyCreateLabel = createBtn?.dataset.labelBusy || 'Creating…';
  const redirectCreateLabel = createBtn?.dataset.labelRedirect || 'Opening dashboard…';

  function updateStatusItem(element, text, tone, note) {
    if (!element) return;
    const textEl = element.querySelector('.status-text');
    const noteEl = element.querySelector('.status-note');
    if (textEl) textEl.textContent = text;
    else element.textContent = text;
    if (noteEl && typeof note === 'string') noteEl.textContent = note;
    element.classList.remove('ok', 'warn', 'err');
    if (tone) element.classList.add(tone);
  }

  function setCreateButtonState(state, labelOverride) {
    if (!createBtn) return;
    const label = labelOverride || (
      state === 'busy' ? busyCreateLabel :
      state === 'redirect' ? redirectCreateLabel :
      defaultCreateLabel
    );
    if (createBtnLabel) createBtnLabel.textContent = label;

    if (state === 'busy' || state === 'redirect') {
      createBtn.disabled = true;
      createBtn.classList.add('is-busy');
    } else {
      createBtn.disabled = false;
      createBtn.classList.remove('is-busy');
    }
  }

  setCreateButtonState('idle');

  function setOAuthStatus(message, tone) {
    if (!oauthStatus) return;
    oauthStatus.textContent = message || "";
    oauthStatus.style.color =
      tone === "ok" ? "#22d3ee" :
      tone === "err" ? "#ff7b7b" :
      tone === "warn" ? "#ffd166" : "";
  }

  function setCreateStatus(message, tone) {
    if (!createStatus) return;
    createStatus.textContent = message || "";
    createStatus.style.color =
      tone === "ok" ? "#22d3ee" :
      tone === "err" ? "#ff7b7b" :
      tone === "warn" ? "#ffd166" : "";
  }

  function updateStatusDashboard() {
    const username = $("username")?.value?.trim() || state.username;
    const botName = $("botName")?.value?.trim();

    const requiredInputs = [
      $("username"), $("botName"),
      $("p_name"), $("p_role"), $("p_tone"), $("p_voice"),
      $("cs_style"), $("cs_humor"), $("cs_emoji"), $("cs_hash"),
      $("ie_primary"), $("ie_secondary"), $("ie_buzz_use"), $("ie_buzz_avoid"),
      $("ca_style"), $("ca_cta"), $("ca_audience"), $("ca_value"),
      $("bv_ex"), $("bv_cu"), $("bv_au"), $("bv_en"),
      $("pg_length"), $("pg_mix"), $("pg_response"), $("pg_brand")
    ];

    const missing = requiredInputs.filter((input) => !input || !input.value.trim());
    const formComplete = missing.length === 0;

    if (formComplete) {
      updateStatusItem(statusForm, '1️⃣ Form: Details captured', 'ok', 'Ready');
    } else {
      updateStatusItem(statusForm, `1️⃣ Form: ${missing.length} fields remaining`, 'warn', 'Fill persona + schedules');
    }

    if (botName) {
      updateStatusItem(statusBot, `3️⃣ Bot: ${botName} (ready to create)`, 'warn', 'Create to finish');
    } else {
      updateStatusItem(statusBot, '3️⃣ Bot: Name not set', '', 'Add a bot name');
    }
  }

  // Restore defaults and populate input fields
  (() => {
    if ($("username")) $("username").value = state.username;
    if ($("botName")) $("botName").value = state.botName;
    if ($("postSchedule") && saved.postSchedule) $("postSchedule").value = saved.postSchedule;
    if ($("replySchedule") && saved.replySchedule) $("replySchedule").value = saved.replySchedule;
  })();

  // Save Defaults (only for fields that exist on this page)
  const saveBtn = $("btnSaveDefaults");
  if (saveBtn) {
    saveBtn.addEventListener("click", () => {
      const username = $("username")?.value?.trim() || state.username;
      const botName = $("botName")?.value?.trim();
      localStorage.setItem("tbp.defaults", JSON.stringify({
        username,
        botName,
        postSchedule: $("postSchedule")?.value,
        replySchedule: $("replySchedule")?.value,
      }));
      state.username = username;
      state.botName = botName;
      if (responseEl) responseEl.textContent = P({ message: "Defaults saved." });
      updateStatusDashboard();
      setCreateStatus("Defaults saved for quick setup.", "ok");
    });
  }

  function buildPayload() {
    const customRaw = $("custom_instructions")?.value || "";
    const custom = customRaw.split("\n").map(s => s.trim()).filter(Boolean);

    // Use username from input field first, then fall back to URL params/localStorage
    const username = $("username")?.value?.trim() || state.username;

    const payload = {
      username,
      bot_name: $("botName")?.value?.trim(),
      persona_settings: {
        personality: {
          name: $("p_name")?.value?.trim(),
          role: $("p_role")?.value?.trim(),
          tone: $("p_tone")?.value?.trim(),
          voice: $("p_voice")?.value?.trim()
        },
        communication_style: {
          writing_style: $("cs_style")?.value?.trim(),
          humor_level: $("cs_humor")?.value?.trim(),
          emoji_usage: $("cs_emoji")?.value?.trim(),
          hashtag_strategy: $("cs_hash")?.value?.trim()
        },
        interests_and_expertise: {
          primary_focus: $("ie_primary")?.value?.trim(),
          secondary_interests: $("ie_secondary")?.value?.trim(),
          buzzwords_to_use: $("ie_buzz_use")?.value?.trim(),
          buzzwords_to_avoid: $("ie_buzz_avoid")?.value?.trim()
        },
        content_approach: {
          marketing_style: $("ca_style")?.value?.trim(),
          call_to_action: $("ca_cta")?.value?.trim(),
          target_audience: $("ca_audience")?.value?.trim(),
          value_proposition: $("ca_value")?.value?.trim()
        },
        brand_voice_examples: {
          excitement: $("bv_ex")?.value?.trim(),
          curiosity: $("bv_cu")?.value?.trim(),
          authority: $("bv_au")?.value?.trim(),
          encouragement: $("bv_en")?.value?.trim()
        },
        posting_guidelines: {
          tweet_length: $("pg_length")?.value?.trim(),
          content_mix: $("pg_mix")?.value?.trim(),
          response_style: $("pg_response")?.value?.trim(),
          brand_consistency: $("pg_brand")?.value?.trim()
        },
        custom_instructions: custom
      },
      post_schedule: $("postSchedule")?.value,
      reply_schedule: $("replySchedule")?.value
    };
    return payload;
  }

  function setValue(id, value) {
    const el = $(id);
    if (!el) return;
    el.value = value != null ? value : "";
  }

  function applyBotData(data) {
    const root = data?.bot || data?.bot_info || data || {};
    // Note: Twitter credentials now handled via OAuth - no manual input fields

    const persona = root.persona || root.persona_settings;
    if (persona) {
      const personality = persona.personality || {};
      setValue("p_name", personality.name);
      setValue("p_role", personality.role);
      setValue("p_tone", personality.tone);
      setValue("p_voice", personality.voice);

      const communication = persona.communication_style || {};
      setValue("cs_style", communication.writing_style);
      setValue("cs_humor", communication.humor_level);
      setValue("cs_emoji", communication.emoji_usage);
      setValue("cs_hash", communication.hashtag_strategy);

      const interests = persona.interests_and_expertise || {};
      setValue("ie_primary", interests.primary_focus);
      setValue("ie_secondary", interests.secondary_interests);
      setValue("ie_buzz_use", interests.buzzwords_to_use);
      setValue("ie_buzz_avoid", interests.buzzwords_to_avoid);

      const content = persona.content_approach || {};
      setValue("ca_style", content.marketing_style);
      setValue("ca_cta", content.call_to_action);
      setValue("ca_audience", content.target_audience);
      setValue("ca_value", content.value_proposition);

      const voice = persona.brand_voice_examples || {};
      setValue("bv_ex", voice.excitement);
      setValue("bv_cu", voice.curiosity);
      setValue("bv_au", voice.authority);
      setValue("bv_en", voice.encouragement);

      const posting = persona.posting_guidelines || {};
      setValue("pg_length", posting.tweet_length);
      setValue("pg_mix", posting.content_mix);
      setValue("pg_response", posting.response_style);
      setValue("pg_brand", posting.brand_consistency);

      if (Array.isArray(persona.custom_instructions) && $("custom_instructions")) {
        $("custom_instructions").value = persona.custom_instructions.join("\n");
      }
    }

    const schedule = root.schedule || root;
    if (schedule.post_schedule && $("postSchedule")) $("postSchedule").value = schedule.post_schedule;
    if (schedule.reply_schedule && $("replySchedule")) $("replySchedule").value = schedule.reply_schedule;
  }

  async function fetchBotDetails(username, botName) {
    const res = await fetch(`${API_BASE_URL}/users/${encodeURIComponent(username)}/bots/${encodeURIComponent(botName)}`, {
      method: "GET",
      headers: { "Accept": "application/json" }
    });
    const data = await safeJson(res);
    return { ok: res.ok, status: res.status, data };
  }

  async function refreshBotFromServer({ notify } = {}) {
    const username = $("username")?.value?.trim() || state.username;
    const botName = $("botName")?.value?.trim();
    if (!username || !botName) return null;

    try {
      const result = await fetchBotDetails(username, botName);
      if (result.ok) {
        applyBotData(result.data);
        if (preview) preview.textContent = P(buildPayload());
        if (notify) setOAuthStatus("Loaded saved bot data", "ok");
      } else if (notify) {
        const msg = result.status === 404 ? "No saved data found yet" : `Load failed (${result.status})`;
        setOAuthStatus(msg, result.status === 404 ? "warn" : "err");
      }
      return result;
    } catch (err) {
      if (notify) setOAuthStatus(`Failed to load bot: ${err.message}`, "err");
      return { ok: false, error: err };
    }
  }

  // Live preview and status updates
  const inputs = Array.from(document.querySelectorAll("input, textarea, select"));
  inputs.forEach(el => el.addEventListener("input", () => {
    if (preview) preview.textContent = P(buildPayload());
    updateStatusDashboard();
  }));
  if (preview) preview.textContent = P(buildPayload());
  updateStatusDashboard();
  if (state.username && state.botName) {
    verifyBotCredentials(state.username, state.botName, false);
  }

  // -------- Load Example (fills ALL fields) --------
  $("btnLoadExample").addEventListener("click", () => {
    // Bot identity + schedules
    const botNameField = $("botName");
    if (botNameField && !botNameField.value) botNameField.value = "marketing_pro_bot";
    if ($("postSchedule")) $("postSchedule").value = "daily";
    if ($("replySchedule")) $("replySchedule").value = "hourly";

    // Note: Twitter credentials now handled via OAuth - no manual input fields

    // Persona — Personality
    if ($("p_name")) $("p_name").value = "Marketing Pro";
    if ($("p_role")) $("p_role").value = "Digital Marketing Expert";
    if ($("p_tone")) $("p_tone").value = "Professional yet friendly";
    if ($("p_voice")) $("p_voice").value = "Authoritative but approachable";

    // Persona — Communication Style
    if ($("cs_style")) $("cs_style").value = "Clear and concise";
    if ($("cs_humor")) $("cs_humor").value = "Light";
    if ($("cs_emoji")) $("cs_emoji").value = "Moderate";
    if ($("cs_hash")) $("cs_hash").value = "2-3 relevant hashtags";

    // Persona — Interests & Expertise
    if ($("ie_primary")) $("ie_primary").value = "Digital Marketing";
    if ($("ie_secondary")) $("ie_secondary").value = "Tech trends, entrepreneurship";
    if ($("ie_buzz_use")) $("ie_buzz_use").value = "growth, optimize, scale";
    if ($("ie_buzz_avoid")) $("ie_buzz_avoid").value = "synergy, paradigm";

    // Persona — Content Approach
    if ($("ca_style")) $("ca_style").value = "Value-first";
    if ($("ca_cta")) $("ca_cta").value = "Subtle";
    if ($("ca_audience")) $("ca_audience").value = "Business owners";
    if ($("ca_value")) $("ca_value").value = "Actionable insights";

    // Persona — Brand Voice Examples
    if ($("bv_ex")) $("bv_ex").value = "🚀 Ready to grow?";
    if ($("bv_cu")) $("bv_cu").value = "What if there was a better way?";
    if ($("bv_au")) $("bv_au").value = "Here's what works:";
    if ($("bv_en")) $("bv_en").value = "You've got this!";

    // Persona — Posting Guidelines
    if ($("pg_length")) $("pg_length").value = "150-280 chars";
    if ($("pg_mix")) $("pg_mix").value = "70% value, 30% engagement";
    if ($("pg_response")) $("pg_response").value = "Quick and helpful";
    if ($("pg_brand")) $("pg_brand").value = "Always professional";

    // Custom instructions (only if the textarea exists)
    if ($("custom_instructions")) {
      $("custom_instructions").value = `Always provide actionable advice
Keep tone positive and motivating
Include relevant hashtags`;
    }

    if (preview) preview.textContent = P(buildPayload());
    state.botName = $("botName")?.value?.trim() || state.botName;
    updateStatusDashboard();
  });

  // -------- Create Bot logic (unchanged except safe guards) --------
  async function safeJson(res) {
    try { return await res.json(); } catch { return { raw: await res.text().catch(() => "") }; }
  }

  async function fetchBotInfo(username, botName) {
    if (!username || !botName) {
      return { ok: false, reason: 'missing-context' };
    }

    try {
      const res = await fetch(`${API_BASE_URL}/users/${encodeURIComponent(username)}/bots/${encodeURIComponent(botName)}`);
      const data = await safeJson(res);
      if (!res.ok) {
        return { ok: false, status: res.status, data };
      }
      return { ok: true, status: res.status, data };
    } catch (error) {
      return { ok: false, error };
    }
  }

  function extractCredentials(botResponse) {
    if (!botResponse) return null;
    const root = botResponse.bot_info || botResponse.bot || botResponse;
    return root?.twitter_credentials || root?.credentials || null;
  }

  async function verifyBotCredentials(username, botName, notify = true) {
    const result = await fetchBotInfo(username, botName);
    if (!result.ok) {
      const detail = result.data?.detail;
      const indicatesCreds = typeof detail === 'string' && detail.includes('Twitter credentials');
      if (indicatesCreds) {
        updateStatusItem(statusTwitter, '2️⃣ Twitter: Connected ✅', 'ok', 'Connected');
        return { ok: true };
      }

      if (notify) {
        setCreateStatus('⚠️ Unable to verify Twitter credentials. Please connect again.', 'warn');
      }
      updateStatusItem(statusTwitter, '2️⃣ Twitter: Not connected', 'warn', 'Link account');
    } else {
      const creds = extractCredentials(result.data?.bot_info || result.data);
      const hasTokens = creds && creds.access_token && creds.access_token_secret;
      if (hasTokens) {
        updateStatusItem(statusTwitter, '2️⃣ Twitter: Connected ✅', 'ok', 'Connected');
        return { ok: true, credentials: creds };
      }
      if (notify) {
        setCreateStatus('⚠️ Twitter credentials missing. Reconnect via "Connect Twitter".', 'warn');
      }
      updateStatusItem(statusTwitter, '2️⃣ Twitter: Credentials missing', 'err', 'Reconnect');
    }
    return { ok: false };
  }

  const connectBtn = $("btnConnectTwitter");
  if (connectBtn && window.TwitterOAuth) {
    connectBtn.addEventListener("click", async () => {
      const username = $("username")?.value?.trim() || state.username;
      const botName = $("botName")?.value?.trim() || state.botName;

      if (!username) {
        setOAuthStatus("Enter a username before linking Twitter", "warn");
        return;
      }
      if (!botName) {
        setOAuthStatus("Enter a bot name before linking Twitter", "warn");
        return;
      }

      state.username = username;
      state.botName = botName;

      const originalLabel = connectBtn.textContent;
      connectBtn.disabled = true;
      connectBtn.textContent = "Connecting…";

      try {
        setOAuthStatus("Opening Twitter authorization…");
        const outcome = await TwitterOAuth.start({
          apiBaseUrl: API_BASE_URL,
          username,
          botName,
          ensureUser: (name) => ensureUser(API_BASE_URL, name),
          onPopupBlocked: () => setOAuthStatus("Please enable popups for this site", "warn"),
        });

        if (responseEl) {
          responseEl.textContent = P({ oauth: outcome?.payload || { status: "success" } });
        }

        // Get account info from OAuth response
        const accountLabel = outcome?.payload?.accountUsername
          ? `@${outcome.payload.accountUsername}`
          : outcome?.payload?.accountId
            ? `account ${outcome.payload.accountId}`
            : "";

        setOAuthStatus(
          accountLabel ? `✅ Connected as ${accountLabel}` : "✅ Twitter connected!",
          "ok"
        );

        let verification = await verifyBotCredentials(username, botName, false);
        if (!verification.ok) {
          await new Promise((resolve) => setTimeout(resolve, 750));
          await verifyBotCredentials(username, botName, false);
        }

        state.botName = botName;
      } catch (err) {
        setOAuthStatus(`Twitter auth failed: ${err.message}`, "err");
        updateStatusItem(statusTwitter, '2️⃣ Twitter: Authorization failed', 'err', 'Try again');
      } finally {
        connectBtn.disabled = false;
        connectBtn.textContent = originalLabel;
      }
    });
  }

  async function ensureUser(baseUrl, username) {
    const existsRes = await fetch(`${baseUrl}/users/${encodeURIComponent(username)}/exists`, { method: "GET" });
    const existsData = await safeJson(existsRes);
    if (existsRes.ok && existsData.exists) return { created: false, exists: true };

    const createRes = await fetch(`${baseUrl}/users`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify({ username })
    });
    const createData = await safeJson(createRes);
    return { created: createRes.ok, data: createData, status: createRes.status };
  }

  async function createBot() {
    if (!createBtn) return;
    let redirecting = false;

    try {
      setCreateStatus("🔄 Starting bot creation...", "");
      setCreateButtonState('busy');

      const payload = buildPayload();
      state.username = payload.username;
      state.botName = payload.bot_name;

      if (!payload.username) {
        setCreateStatus("❌ Username is required", "err");
        if (responseEl) responseEl.textContent = P({ error: "Username is required. Pass it via URL parameter ?username=your_username or save it using Save Defaults." });
        updateStatusItem(statusForm, '1️⃣ Form: Details incomplete', 'warn', 'Add username');
        setCreateButtonState('idle');
        return;
      }

      if (!payload.bot_name) {
        setCreateStatus("❌ Bot name is required", "err");
        if (responseEl) responseEl.textContent = P({ error: "Bot name is required." });
        updateStatusItem(statusBot, '3️⃣ Bot: Name not set', '', 'Add a bot name');
        setCreateButtonState('idle');
        return;
      }

      updateStatusItem(statusForm, '1️⃣ Form: Details captured', 'ok', 'Ready');
      updateStatusItem(statusBot, `3️⃣ Bot: ${payload.bot_name} (ready to create)`, 'warn', 'Creating…');

      let credentialStatus = await verifyBotCredentials(payload.username, payload.bot_name, false);
      if (!credentialStatus.ok) {
        await new Promise((resolve) => setTimeout(resolve, 750));
        credentialStatus = await verifyBotCredentials(payload.username, payload.bot_name, false);
      }

      if (!credentialStatus.ok) {
        setCreateStatus('❌ Twitter account not connected yet. Complete the OAuth flow and try again.', 'err');
        updateStatusItem(statusBot, `3️⃣ Bot: ${payload.bot_name} (waiting for credentials)`, 'warn', 'Reconnect Twitter');
        setCreateButtonState('idle');
        return;
      }

      setCreateStatus("✅ Ensuring user exists...", "");

      const userResult = await ensureUser(API_BASE_URL, payload.username);
      if (userResult.created) {
        setCreateStatus("✅ User created - preparing bot...", "");
      } else {
        setCreateStatus("✅ User found - preparing bot...", "");
      }

      setCreateStatus("✅ Validation passed - creating bot...", "");

      const res = await fetch(`${API_BASE_URL}/bots`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await safeJson(res);

      if (responseEl) {
        responseEl.textContent = P({ ok: res.ok, status: res.status, data });
      }

      if (res.ok) {
        setCreateStatus("🎉 Bot created successfully! Opening dashboard...", "ok");
        updateStatusItem(
          statusBot,
          `3️⃣ Bot: ${payload.bot_name} ✅ Created!`,
          'ok',
          'Created'
        );
        redirecting = true;
        setCreateButtonState('redirect');
        const redirectUrl = new URL('dashboard.html', window.location.href);
        redirectUrl.searchParams.set('username', payload.username);
        if (payload.bot_name) redirectUrl.searchParams.set('bot_name', payload.bot_name);
        setTimeout(() => {
          window.location.href = redirectUrl.toString();
        }, 900);
      } else {
        const errorMsg = data.detail || data.message || `HTTP ${res.status}`;
        setCreateStatus(`❌ Creation failed: ${errorMsg}`, "err");
        updateStatusItem(statusBot, '3️⃣ Bot: Creation failed', 'err', 'Check details');
      }
    } catch (e) {
      setCreateStatus(`❌ Error: ${e.message}`, "err");
      if (responseEl) responseEl.textContent = P({ ok: false, error: String(e) });
    } finally {
      if (!redirecting) {
        setCreateButtonState('idle');
      }
    }
  }

  const createBtnEl = document.getElementById("btnCreate");
  if (createBtnEl) createBtnEl.addEventListener("click", createBot);

  // Initialize status dashboard on page load
  document.addEventListener("DOMContentLoaded", () => {
    updateStatusDashboard();
  });
</script>

</body>
</html>
